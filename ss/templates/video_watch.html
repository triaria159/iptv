<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ video.title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <!-- ì œëª©ê³¼ ì¸ë„¤ì¼ -->
        <div class="text-center mb-4">
            <h1 class="display-5 fw-bold">{{ video.title }}</h1>
            <img src="{{ video.thumbnail }}" id="thumbnail" class="img-fluid rounded mb-4" alt="Thumbnail">
        </div>
        
        <!-- ì˜ìƒ ìƒì„¸ ì •ë³´ -->
        <div class="card shadow p-4 mb-4">
            <h2 class="fw-bold">ğŸ“‹ ì˜ìƒ ìƒì„¸ ì •ë³´</h2>
            <ul class="list-group list-group-flush">
                <li class="list-group-item"><strong>ì˜ìƒ ID:</strong> {{ video.videoId }}</li>
                <li class="list-group-item"><strong>ì´ ì˜ìƒ ê¸¸ì´:</strong> {{ video.duration // 60 }}ë¶„ {{ video.duration % 60 }}ì´ˆ</li>
                <li class="list-group-item"><strong>ëˆ„ì  ì‹œì²­ ì‹œê°„:</strong> {{ video.totalTime // 60 }}ë¶„ {{ video.totalTime % 60 }}ì´ˆ</li>
            </ul>
        </div>
        
        <!-- ì˜ìƒ ì‹œì²­ ì˜ì—­ -->
        <div id="videoSection" class="text-center d-none">
            <!-- YouTube ì˜ìƒ iframe -->
            <iframe id="youtubePlayer"
                    width="560"
                    height="315"
                    src="https://www.youtube.com/embed/{{ video.videoId }}?enablejsapi=1"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
            </iframe>
        </div>
        
        <!-- ì‹œì²­ ë²„íŠ¼ ë° ìƒíƒœ -->
        <div class="text-center">
            <button id="startWatch" class="btn btn-primary">ì˜ìƒ ì‹œì²­ ì‹œì‘</button>
            <p id="watchStatus" class="mt-3"></p>
        </div>
    </div>

    <script>
        let startTime, interval;

        // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ê°’ ê°€ì ¸ì˜¤ê¸°
        const videoId = "{{ video.videoId }}";
        const duration = parseInt("{{ video.duration }}", 10);
        let totalTime = parseInt("{{ video.totalTime }}", 10);

        const watchStatus = document.getElementById("watchStatus");
        const thumbnail = document.getElementById("thumbnail");
        const videoSection = document.getElementById("videoSection");

        // ì˜ìƒ ì‹œì²­ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('startWatch').addEventListener('click', () => {
            if (!startTime) {
                // í˜„ì¬ ì‹œê°„ì„ ì‹œì‘ ì‹œê°„ìœ¼ë¡œ ì„¤ì •
                startTime = Date.now();

                // ì¸ë„¤ì¼ ìˆ¨ê¸°ê³  iframe í‘œì‹œ
                thumbnail.style.display = "none";
                videoSection.classList.remove("d-none");
                watchStatus.textContent = "ì‹œì²­ ì¤‘...";

                // 5ì´ˆë§ˆë‹¤ ì‹œì²­ ì‹œê°„ ì„œë²„ë¡œ ì „ì†¡
                interval = setInterval(sendWatchData, 5000);
            }
        });

        // ì‹œì²­ ì‹œê°„ ì„œë²„ë¡œ ì „ì†¡
        async function sendWatchData() {
            const currentTime = Date.now();
            const watchedTime = Math.floor((currentTime - startTime) / 1000);  // ì‹œì²­ ì‹œê°„(ì´ˆ)

            const response = await fetch('/record_watch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ videoId, watchedTime, duration })
            });

            const result = await response.json();
            if (result.error) {
                watchStatus.textContent = `ì—ëŸ¬: ${result.error}`;
            } else {
                totalTime = result.totalTime;  // ëˆ„ì  ì‹œì²­ ì‹œê°„ ì—…ë°ì´íŠ¸
                watchStatus.textContent = `ì‹œì²­ ì‹œê°„: ${totalTime}ì´ˆ (${result.percentage.toFixed(2)}%)`;
            }
        }
    </script>
</body>
</html>
